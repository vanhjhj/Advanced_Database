-- Tạo filegroup cho các phân vùng
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2010;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2011;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2012;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2013;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2014;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2015;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2016;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2017;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2018;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2019;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2020;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2021;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2022;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2023;
ALTER DATABASE QUAN_LY_NHA_HANG ADD FILEGROUP FG_2024;

-- Tạo tệp dữ liệu cho từng filegroup
ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2010',
    FILENAME = 'D:\HD_FG_2010.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2010;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2011',
    FILENAME = 'D:\HD_FG_2011.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2011;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2012',
    FILENAME = 'D:\HD_FG_2012.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2012;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2013',
    FILENAME = 'D:\HD_FG_2013.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2013;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2014',
    FILENAME = 'D:\HD_FG_2014.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2014;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2015',
    FILENAME = 'D:\HD_FG_2015.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2015;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2016',
    FILENAME = 'D:\HD_FG_2016.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2016;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2017',
    FILENAME = 'D:\HD_FG_2017.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2017;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2018',
    FILENAME = 'D:\HD_FG_2018.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2018;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2019',
    FILENAME = 'D:\HD_FG_2019.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2019;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2020',
    FILENAME = 'D:\HD_FG_2020.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2020;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2021',
    FILENAME = 'D:\HD_FG_2021.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2021;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2022',
    FILENAME = 'D:\HD_FG_2022.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2022;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2023',
    FILENAME = 'D:\HD_FG_2023.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2023;

ALTER DATABASE QUAN_LY_NHA_HANG
ADD FILE (
    NAME = 'HD_FG_2024',
    FILENAME = 'D:\HD_FG_2024.ndf',
    SIZE = 2MB
) TO FILEGROUP FG_2024;

-- Tạo hàm partition
GO
CREATE PARTITION FUNCTION PF_HoaDon_NgayLapHD(DATETIME)
AS RANGE RIGHT FOR VALUES ('2011-01-01','2012-01-01','2013-01-01','2014-01-01','2015-01-01',
						   '2016-01-01','2017-01-01','2018-01-01','2019-01-01','2020-01-01',
						   '2021-01-01','2022-01-01','2023-01-01','2024-01-01');
GO

-- Đổ dữ liệu vào cái partition scheme
CREATE PARTITION SCHEME PS_HoaDon_NgayLapHD 
AS PARTITION PF_HoaDon_NgayLapHD 
TO ([FG_2010], [FG_2011], [FG_2012], [FG_2013], [FG_2014],
	[FG_2015], [FG_2016], [FG_2017], [FG_2018], [FG_2019],
	[FG_2020], [FG_2021], [FG_2022], [FG_2023], [FG_2024]);
GO

-- Bỏ khóa ngoại tham chiếu tới HoaDon trước khi partition
ALTER TABLE dbo.DanhGia
DROP CONSTRAINT FK_DanhGia_HoaDon;

-- Bỏ clustered index trên MaHD
ALTER TABLE dbo.HoaDon
DROP CONSTRAINT PK__HoaDon__2725A6E016816A30;

-- Thêm lại non-clustered index cho MaHD
ALTER TABLE dbo.HoaDon
ADD PRIMARY KEY 
NONCLUSTERED (MaHD)
ON [PRIMARY];

-- Thêm lại khóa ngoại cho DanhGia
ALTER TABLE dbo.DanhGia
ADD CONSTRAINT FK_DanhGia_HoaDon
FOREIGN KEY (MaHD) REFERENCES dbo.HoaDon (MaHD);

-- Tạo clustered index trên thuộc tính được dùng để partition NgayLapHD
CREATE CLUSTERED INDEX Idx_HoaDon_NgayLapHD 
ON dbo.HoaDon (NgayLapHD) ON PS_HoaDon_NgayLapHD (NgayLapHD);
--DROP INDEX Idx_HoaDon_NgayLapHD ON dbo.HoaDon;




